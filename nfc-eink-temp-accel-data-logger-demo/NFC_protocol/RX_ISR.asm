;/INCLUDES----------------------------------------------------------------------------------------------------------------------------
	.cdecls C, LIST, "../common/globals.h","_14443_B.h"
	.define "0", SR_SP_OFF
;Register Defs
R_rxBuf         .set R4     ;point to rx_buffer
R_currentByte   .set R5     ;store currentByte
R_bits          .set R6     ;store the number of receiving bits
R_currentBit    .set R7     ;store current bit position
R_sum           .set R8     ;store current bits + num of receiving bits
R_debug         .set R9
;/************************************************************************************************************************************
;*                                 PORT 1 ISR (Starting a Command Receive)                                                           *
;* Theory: RX ISR Will perform two different functions:                                                                              *
;*       - #1: RX ISR triggers on rising edge that indicates the beginning of fram to wakeup the RX. It will then wakeup RX          *
;*                                                                                                                                   *
;*       - #2: RX ISR triggers on rising edge that indicates the end of a delimiter. It then sets up TA1 Capture for triggering the  *
;*               remaining data bits.                                                												 *
;*                                                                    																 *
;* @Note: If incorrect delimiter is found, then wakeup from LMP3 and waiting for the next reading roun                      		 *
;* 		  max 14+66=82 cpu cycles, max measured delay is 6us
;
;*************************************************************************************************************************************/
RX_ISR:                          ;[X]t=76ns @13.56Mhz
;*********************************************************************************************************************************
; Select ISR handler
;********************************************************************************************************************************
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ADD    &P1IV,    PC              ;[2]
  RETI                           ;[2]vecotr 0
  JMP    Other_HND               ;[2]port1 bit0
  JMP    Other_HND               ;[2]port1 bit1
  JMP    RX_WAKEUP_ISR              ;[2]port1 bit2
  JMP    RX_HND                  ;[2]port1 bit3
  JMP    Other_HND               ;[2]port1 bit4
  JMP    Other_HND               ;[2]port1 bit5
  JMP    Other_HND               ;[2]port1 bit6
  JMP    Other_HND               ;[2]port1 bit6
  JMP    ACELL_INT1_HND          ;[2]port1 bit7

RX_HND:
  MOV   &TA0R,  R_bits           ;[2]move counted cycles in to bits buffer
  CLR   &TA0R
  ADD.B #Dt,    R_bits           ;[2]Add tolorence to R_bits
  CLR.B &RX_IFG                  ;[2]clear port 1 flag
  ;XOR.B #LED_1_BIT, &LED_1_OUT	 ;[2]debug
  BIT.B #NFC_Rx2,  &doNFC_state  ;[3]Which state it is right now
  JNZ ReadBits
  BIT.B #NFC_Rx1,  &doNFC_state
  JNZ TestSOF
  BIT.B #NFC_Rx0,  &doNFC_state
  JNZ TestDelim
Other_HND:
  CLR.B &RX_IFG
  CLR.B &RX_IE
  RETI

;*********************************************************************************************************************************
; decoding bits (max ) doNFC_state = NFC_Rx2
;*********************************************************************************************************************************
ReadBits:
  ;MOV.B R_bits,	R_debug			  ;[2]debug
  RRA   R_bits                    ;[2] num of bits is received
  RRA   R_bits
  RRA   R_bits
  RRA   R_bits
  JZ	WAKEUP_ISR				  ;[2] not valid bits wake up
  CMP.B #10, R_bits
  JGE	WAKE_UP_LPM4				  ;[2] not valid bits wake up
  CMP.B  #0, R_currentBit         ;[2]
  JEQ    StartOfByte
  MOV.B R_currentBit, R_sum       ;[2] the sum of bits (current+received);
  ADD.B R_bits, R_sum             ;[2]
  CMP.B #9,     R_sum             ;[2] R_temp<9?
  JL Update_bits                  ;[2] If R_sum<9 jump
  MOV.B #9,     R_sum
  MOV.B #9,     R_bits
  SUB.B R_currentBit, R_bits      ;[4]R_bits =9-R_currentBit

Update_bits:
  MOV.B R_sum, R_currentBit       ;[2]update R_currentBit to be either 9 or R_bits+R_currentBit
  BIT.B #RX_BIT, &RX_IES          ;[2] jump if receive 1
  JNZ ShiftloopAdd

Shiftloop:
  RRA R_currentByte               ;[2]must be RRA not RRA.B
  SUB.B #1, R_bits                ;[2]R_bits -1
  JNZ Shiftloop
  JMP EndByte

ShiftloopAdd:
  RRA  R_currentByte             ;[2]Shift right and add 1
  ADD.B #0x80,    R_currentByte   ;[2] add 1 to the MSB
  SUB.B #1, R_bits                ;[2]R_bits -1
  JNZ ShiftloopAdd
  JMP EndByte

StartOfByte:
  BIT.B #RX_BIT,  &RX_IES         ;[2] if receive 0 at rising edge
  JNZ   EndByte                   ;[2]if receive 1(falling edge) jump to EndByte
  MOV.B #0x00,    R_currentByte   ;[2]clear current Byte buffer
  MOV.B R_bits,   R_currentBit    ;[2]currentBit is R_bits

EndByte:
  XOR.B #RX_BIT,  &RX_IES         ;[2]toggle edge
  ;XOR.B #LED_2_BIT, &LED_2_OUT	 ;[2]debug indication
  CMP.B #9,       R_currentBit    ;[2]
  JNZ End_HND
  MOV.B R_currentByte, 0(R_rxBuf)  ;[4] update current rx_buffer
  INC.W R_rxBuf
  ADD.B #1,       &_14443_buf_ptr  ;[2]
  CLR.B R_currentBit
  ;XOR.B #LED_2_BIT, &LED_2_OUT	 ;[2]debug indication
End_HND:
  RETI

;*********************************************************************************************************************************
; TestSOF (max 14) doNFC_state = NFC_Rx1
;*********************************************************************************************************************************
TestSOF:
  AND.B #0xF0,R_bits                ;[2]
  CMP.B #0x20,R_bits                ;[2]
  JEQ   ValidSOF                    ;[1] Jump if R_bits==2 cycles @106k

WAKEUP_ISR:
  CLR.B  &RX_IFG            		 ;[2]clear port1 flag
  CLR.B  &validRx     ;[2]validRx
WAKE_UP_LPM4:
  BIC    #(SCG1+SCG0+OSCOFF+CPUOFF+GIE), SR_SP_OFF(SP)   ;[4]wake up from LPM4
  RETI

ValidSOF:
  MOV.B #EOF, &TA0CCR0		        ;[2]
  BIC.B #RX_BIT,  &RX_IES           ;[2]rising edge
  MOV.B #NFC_Rx2, &doNFC_state		;[2]set BIT2 in doNFC_state
  RETI

;*********************************************************************************************************************************
; TestDelim (max 13 cycles) doNFC_state = NFC_Rx0
;*********************************************************************************************************************************
TestDelim:
  CMP.B #SOF, R_bits                ;[2]
  JL    WAKEUP_ISR                  ;[2]jump R_bits<SOF
  BIS.B #RX_BIT,  &RX_IES           ;[2]falling edge
  MOV.B #THREE_PULSES,  &TA0CCR0    ;[2]TIMEOUT is 3 pulses@106k
  BIS.B #BIT0,      &validRx;[2]set flag
  MOV.W #(rx_buffer), R_rxBuf       ;[2]load the rx_buffer to the reg!
  CLR.B R_currentBit                ;[2]
  MOV.B #NFC_Rx1,   &doNFC_state    ;[2]set NFC_Rx1 in doNFC_state
  RETI

;*********************************************************************************************************************************
; Detect edges in either sleep_till_read or sleep_till_edge (max 14) doNFC_state = BIT4/BIT3
;*********************************************************************************************************************************
RX_WAKEUP_ISR:
  MOV.B  #NFC_Start,  &doNFC_state  ;[3] if doNFC_state = Sleep now then go to NFC_Start, it is RX_WAKEUP_ISR
  ;CLR.B	 &imageState			;[2] halt image update
  CLR.B  &RX_WAKEUP_IFG             ;[2]clear port1 flag
  ;BIC.B	 #CCIE,  &TA1CCTL0
  BIC    #(0xF8), SR_SP_OFF(SP);[4]wake up from LPM4
  RETI
ACELL_INT1_HND:
  ;***********************************************************************************************************************************
  ;Accelerometer activity or in-activity state
  ; each time detect interrupt leftshit accel_state, if detect activity add 1
  ;***********************************************************************************************************************************
  ADD.B #1, &accelState; 			;//leftsheft the previous one
  ;BIT.B #ACCEL_INT1_BIT &ACCEL_INT1_IES
  ;JNZ resetHND
  ;ADD.B #1 &accelState;								;detect activity so add one to it
  BIC.B #ACCEL_INT1_BIT, &ACCEL_INT1_IFG			;clear interrupt
  ;XOR.B #ACCEL_INT1_BIT,  &ACCEL_INT1_IES 			;toggle actibity state
  BIT.B #NFC_LPM4, &doNFC_state						;if it is in NFC_LPM4 mode
  JZ	return
resetHND:
  MOV.B #NFC_Sleep,	&doNFC_state					;continious set it to be sleep after update ADC
  BIC    #(0xF8), SR_SP_OFF(SP)						;[4]wake up from LPM4 and disable GIE
return:
  RETI
;*************************************************************************************************************************************
; DEFINE THE INTERRUPT VECTOR ASSIGNMENT                                               *
;*************************************************************************************************************************************
  .sect ".int47"          ; Port 1 Vector
  .short  RX_ISR          ; This sect/short pair sets int02 = RX_ISR addr.
  .end
